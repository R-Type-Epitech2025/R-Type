name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  test_server:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install qt5
      uses: jurplel/install-qt-action@v2
      with:
        version: '5.15.2'
        host: linux
        target: desktop
        arch: x86_64
        dir: /opt/qt
    - name: Install SFML
      description: Install Simple and Fast Multimedia Library
      inputs:
        sfml:
          description: The version of SFML to install ("latest", "nightly", "2.5.1")
          default: latest
        config:
          description: The configuration of the build ("Release", "Debug")
          default: Release
        token:
          description: Personal access token (auto-populated)
          default: ${{ github.token }}
      outputs:
        sfml:
          description: The actual version of SFML that was installed
        path:
          description: The directory where SFML was installed, so you can use '[path]/include' etc.
      runs:
        using: node12
        main: index.js
    - name: Install dependencies
    - name: Build
      run: |
        cd server
        cmake -B build -S . -DCMAKE_PREFIX_PATH=/opt/qt/5.15.2/gcc_64/lib/cmake 
        cmake --build build -v
    - name: Run tests
      run: |
        cd server/bin
        ./R-Type_Server
  test_client:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install qt5
      uses: jurplel/install-qt-action@v2
      with:
        version: '5.15.2'
        host: linux
        target: desktop
        arch: x86_64
        dir: /opt/qt
    - name: Install SFML
      description: Install Simple and Fast Multimedia Library
      inputs:
        sfml:
          description: The version of SFML to install ("latest", "nightly", "2.5.1")
          default: latest
        config:
          description: The configuration of the build ("Release", "Debug")
          default: Release
        token:
          description: Personal access token (auto-populated)
          default: ${{ github.token }}
      outputs:
        sfml:
          description: The actual version of SFML that was installed
        path:
          description: The directory where SFML was installed, so you can use '[path]/include' etc.
      runs:
        using: node12
        main: index.js
    - name: Build
      run: |
        cd client
        cmake -B build -S . -DCMAKE_PREFIX_PATH=/opt/qt/5.15.2/gcc_64/lib/cmake
        cmake --build build -v
    - name: Run tests
      run: |
        cd client/bin
        ./R-Type_Client
  push:
    runs-on: ubuntu-latest
    steps:
    - name: push
      uses: andstor/copycat-action@v3
      with:
        personal_token: ${{ secrets.API_GITHUB }}
        src_path: /.
        src_branch: main
        dst_branch: main
        dst_path: /.
        dst_owner: EpitechPromo2025
        dst_repo_name: B-CPP-500-TLS-5-2-rtype-antoine.cadeau
        commit_message: "[CI] - Push to ID: ${{ github.run_id }} by github action from ${{ github.repository }}"